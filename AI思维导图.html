<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ (HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ (Geminiç‰ˆ)</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f9fafb;
        }
        .tree-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .tree ul { position: relative; padding-left: 30px; list-style: none; }
        .tree li { position: relative; padding: 4px 0 4px 25px; }
        .tree ul::before { content: ''; position: absolute; top: 0; left: 0; width: 1px; height: 100%; background-color: #d1d5db; }
        .tree li::before { content: ''; position: absolute; top: 15px; left: 0; width: 25px; height: 1px; background-color: #d1d5db; }
        .tree li::after { content: ''; position: absolute; top: 0; left: 0; width: 1px; height: 100%; background-color: #d1d5db; }
        .tree li:last-child::after { height: 15px; }
        .tree .node { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 8px; background-color: #f3f4f6; color: #374151; transition: all 0.2s ease; min-width: 100px; cursor: pointer; border: 1px solid #e5e7eb; }
        .tree .ai-trigger, .tree .simulation-trigger { margin-left: 8px; font-size: 1.1rem; opacity: 0.6; transition: all 0.2s ease; }
        .tree .node:hover .ai-trigger, .tree .node:hover .simulation-trigger { opacity: 1; transform: scale(1.2); }
        .tree li.has-children > .node { cursor: pointer; font-weight: 500; background-color: #e0e7ff; color: #3730a3; }
        .tree li.has-children > .node:hover { background-color: #c7d2fe; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .tree li.root > .node { background-color: #312e81; color: white; font-weight: 700; font-size: 1.25rem; }
        .tree li.collapsed > ul { display: none; }
        .tree li.has-children > .node > .toggle-icon { content: 'âˆ’'; display: inline-block; margin-right: 8px; font-weight: bold; }
        .tree li.has-children.collapsed > .node > .toggle-icon { content: '+'; }
        .controls { margin-bottom: 1.5rem; text-align: center; }
        .control-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; background-color: #ffffff; color: #374151; font-weight: 500; cursor: pointer; transition: background-color 0.2s; margin-top: 0.5rem; }
        .control-btn:hover { background-color: #f3f4f6; }
        .modal-content { white-space: pre-wrap; line-height: 1.7; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .choice-button { display: block; width: 100%; text-align: left; padding: 0.75rem; margin-bottom: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: #fff; cursor: pointer; }
        .choice-button:hover { background-color: #f9fafb; }
        .choice-button.correct { background-color: #d1fae5; border-color: #059669; color: #065f46; }
        .choice-button.incorrect { background-color: #fee2e2; border-color: #dc2626; color: #991b1b; }
        .choice-button:disabled { opacity: 0.7; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="tree-container">
        <div id="apiKeySetup" class="p-4 mb-6 bg-indigo-50 border border-indigo-200 rounded-lg shadow-sm max-w-2xl mx-auto">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©AIæ¨¡å‹ (Select AI Model):</label>
                <div class="flex items-center space-x-4">
                    <div>
                        <input type="radio" id="modelGemini" name="aiModel" value="gemini" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                        <label for="modelGemini" class="ml-2 block text-sm text-gray-900">Gemini</label>
                    </div>
                    <div>
                        <input type="radio" id="modelDeepseek" name="aiModel" value="deepseek" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                        <label for="modelDeepseek" class="ml-2 block text-sm text-gray-900">DeepSeek</label>
                    </div>
                </div>
            </div>

            <div id="geminiApiKeySection" class="mt-4 p-3 bg-white border border-gray-200 rounded-md">
                <label for="geminiApiKeyInput" class="block text-xs font-medium text-indigo-700 mb-1">Gemini API Key:</label>
                <div class="flex items-center space-x-2">
                    <input type="password" id="geminiApiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="è¯·è¾“å…¥ Gemini API Key">
                    <button id="saveGeminiApiKeyButton" class="px-3 py-1.5 bg-indigo-500 text-white text-xs rounded-md hover:bg-indigo-600">ä¿å­˜Geminiå¯†é’¥</button>
                    <button id="clearGeminiApiKeyButton" class="px-3 py-1.5 bg-red-500 text-white text-xs rounded-md hover:bg-red-600">æ¸…é™¤Geminiå¯†é’¥</button>
                </div>
                <p id="geminiApiKeyMessage" class="text-xs text-gray-500 mt-1"></p>
            </div>

            <div id="deepseekApiKeySection" class="mt-3 p-3 bg-white border border-gray-200 rounded-md">
                <label for="deepseekApiKeyInput" class="block text-xs font-medium text-teal-700 mb-1">DeepSeek API Key:</label>
                <div class="flex items-center space-x-2">
                    <input type="password" id="deepseekApiKeyInput" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 sm:text-sm" placeholder="è¯·è¾“å…¥ DeepSeek API Key">
                    <button id="saveDeepseekApiKeyButton" class="px-3 py-1.5 bg-teal-500 text-white text-xs rounded-md hover:bg-teal-600">ä¿å­˜DeepSeekå¯†é’¥</button>
                    <button id="clearDeepseekApiKeyButton" class="px-3 py-1.5 bg-red-500 text-white text-xs rounded-md hover:bg-red-600">æ¸…é™¤DeepSeekå¯†é’¥</button>
                </div>
                <p id="deepseekApiKeyMessage" class="text-xs text-gray-500 mt-1"></p>
            </div>
             <p class="text-xs text-gray-500 mt-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2zM6 8a1 1 0 11-2 0 1 1 0 012 0zm1 1a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                </svg>
                APIå¯†é’¥å°†å®‰å…¨åœ°å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä»…ç”¨äºä¸æ‰€é€‰AIæ¨¡å‹APIé€šä¿¡ã€‚
            </p>
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ</h1>
        <p id="pageSubtitle" class="text-lg text-center text-gray-500 mb-8">(HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ - Gemini å¢å¼ºç‰ˆ</p>
        
        <div class="mb-8 max-w-2xl mx-auto">
            <form id="aiSearchForm" class="flex items-center gap-2 p-2 border-2 border-indigo-200 rounded-full shadow-lg focus-within:border-indigo-500 transition-all">
                <input type="search" id="aiSearchInput" placeholder="âœ¨ å°±è§„èŒƒå†…å®¹æé—®ï¼Œè®©Geminiä¸ºæ‚¨è§£ç­”..." class="w-full px-4 py-2 text-gray-700 bg-transparent focus:outline-none">
                <button type="submit" class="bg-indigo-600 text-white rounded-full p-2.5 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </form>
        </div>

        <div class="controls space-x-4">
            <button id="expandAll" class="control-btn">å…¨éƒ¨å±•å¼€</button>
            <button id="collapseAll" class="control-btn">å…¨éƒ¨æŠ˜å </button>
        </div>

        <ul class="tree"></ul>
    </div>

    <div id="aiModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-2xl bg-white">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modalContent" class="modal-content text-gray-700 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div id="modalActions" class="mt-4 text-right flex flex-wrap justify-end gap-2"></div>
            <button id="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let selectedAiModel = 'gemini'; 
            let geminiApiKey = null;
            let deepseekApiKey = null;

            // DOM Elements for API Management
            const modelGeminiRadio = document.getElementById('modelGemini');
            const modelDeepseekRadio = document.getElementById('modelDeepseek');
            
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const saveGeminiApiKeyButton = document.getElementById('saveGeminiApiKeyButton');
            const clearGeminiApiKeyButton = document.getElementById('clearGeminiApiKeyButton');
            const geminiApiKeyMessage = document.getElementById('geminiApiKeyMessage');
            
            const deepseekApiKeyInput = document.getElementById('deepseekApiKeyInput');
            const saveDeepseekApiKeyButton = document.getElementById('saveDeepseekApiKeyButton');
            const clearDeepseekApiKeyButton = document.getElementById('clearDeepseekApiKeyButton');
            const deepseekApiKeyMessage = document.getElementById('deepseekApiKeyMessage');

            const pageTitleElement = document.querySelector('title');
            const pageSubtitleElement = document.getElementById('pageSubtitle');
            const aiSearchInputElement = document.getElementById('aiSearchInput');


            function updateDynamicUIText() {
                if (selectedAiModel === 'gemini') {
                    pageTitleElement.textContent = 'åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ (HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ (Geminiç‰ˆ)';
                    pageSubtitleElement.textContent = '(HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ - Gemini å¢å¼ºç‰ˆ';
                    aiSearchInputElement.placeholder = 'âœ¨ å°±è§„èŒƒå†…å®¹æé—®ï¼Œè®©Geminiä¸ºæ‚¨è§£ç­”...';
                } else if (selectedAiModel === 'deepseek') {
                    pageTitleElement.textContent = 'åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ (HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ (DeepSeekç‰ˆ)';
                    pageSubtitleElement.textContent = '(HJ 915-2017) äº¤äº’å¼æ€ç»´å¯¼å›¾ - DeepSeek å¢å¼ºç‰ˆ';
                    aiSearchInputElement.placeholder = 'âœ¨ å°±è§„èŒƒå†…å®¹æé—®ï¼Œè®©DeepSeekä¸ºæ‚¨è§£ç­”...';
                }
            }

            function loadApiKeysAndModelSelection() {
                // Load selected model
                const savedModel = localStorage.getItem('selectedAiModel');
                if (savedModel) {
                    selectedAiModel = savedModel;
                    if (selectedAiModel === 'gemini' && modelGeminiRadio) modelGeminiRadio.checked = true;
                    else if (selectedAiModel === 'deepseek' && modelDeepseekRadio) modelDeepseekRadio.checked = true;
                }
                updateDynamicUIText(); // Update UI text based on loaded or default model

                // Load Gemini Key
                geminiApiKey = localStorage.getItem('geminiApiKey');
                if (geminiApiKey) {
                    if (geminiApiKeyMessage) geminiApiKeyMessage.textContent = 'Gemini API Key: å·²åŠ è½½ã€‚';
                } else {
                    if (geminiApiKeyMessage) geminiApiKeyMessage.textContent = 'Gemini API Key: æœªè®¾ç½®ã€‚';
                }
                if (geminiApiKeyInput) geminiApiKeyInput.value = '';

                // Load DeepSeek Key
                deepseekApiKey = localStorage.getItem('deepseekApiKey');
                if (deepseekApiKey) {
                    if (deepseekApiKeyMessage) deepseekApiKeyMessage.textContent = 'DeepSeek API Key: å·²åŠ è½½ã€‚';
                } else {
                    if (deepseekApiKeyMessage) deepseekApiKeyMessage.textContent = 'DeepSeek API Key: æœªè®¾ç½®ã€‚';
                }
                if (deepseekApiKeyInput) deepseekApiKeyInput.value = '';
            }
            
            // Model Selection Logic
            [modelGeminiRadio, modelDeepseekRadio].forEach(radio => {
                if(radio) radio.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        selectedAiModel = event.target.value;
                        localStorage.setItem('selectedAiModel', selectedAiModel);
                        updateDynamicUIText();
                        // Optionally, clear API status messages for the other model or update emphasis
                        geminiApiKeyMessage.textContent = geminiApiKey ? 'Gemini API Key: å·²åŠ è½½ã€‚' : 'Gemini API Key: æœªè®¾ç½®ã€‚';
                        deepseekApiKeyMessage.textContent = deepseekApiKey ? 'DeepSeek API Key: å·²åŠ è½½ã€‚' : 'DeepSeek API Key: æœªè®¾ç½®ã€‚';
                    }
                });
            });

            // Gemini API Key Management
            if(saveGeminiApiKeyButton) saveGeminiApiKeyButton.addEventListener('click', () => {
                const key = geminiApiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    geminiApiKey = key;
                    geminiApiKeyMessage.textContent = 'Gemini API Key å·²ä¿å­˜!';
                    geminiApiKeyMessage.className = 'text-xs text-green-600 mt-1';
                } else {
                    geminiApiKeyMessage.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„Gemini API Keyã€‚';
                    geminiApiKeyMessage.className = 'text-xs text-red-600 mt-1';
                }
                setTimeout(() => { 
                    geminiApiKeyMessage.textContent = geminiApiKey ? 'Gemini API Key: å·²åŠ è½½ã€‚' : 'Gemini API Key: æœªè®¾ç½®ã€‚';
                    geminiApiKeyMessage.className = 'text-xs text-gray-500 mt-1'; // Reset class
                }, 3000);
            });

            if(clearGeminiApiKeyButton) clearGeminiApiKeyButton.addEventListener('click', () => {
                localStorage.removeItem('geminiApiKey');
                geminiApiKey = null;
                geminiApiKeyInput.value = '';
                geminiApiKeyMessage.textContent = 'Gemini API Key: æœªè®¾ç½®ã€‚';
                geminiApiKeyMessage.className = 'text-xs text-orange-600 mt-1';
            });

            // DeepSeek API Key Management
            if(saveDeepseekApiKeyButton) saveDeepseekApiKeyButton.addEventListener('click', () => {
                const key = deepseekApiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('deepseekApiKey', key);
                    deepseekApiKey = key;
                    deepseekApiKeyMessage.textContent = 'DeepSeek API Key å·²ä¿å­˜!';
                    deepseekApiKeyMessage.className = 'text-xs text-green-600 mt-1';
                } else {
                    deepseekApiKeyMessage.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„DeepSeek API Keyã€‚';
                    deepseekApiKeyMessage.className = 'text-xs text-red-600 mt-1';
                }
                setTimeout(() => { 
                    deepseekApiKeyMessage.textContent = deepseekApiKey ? 'DeepSeek API Key: å·²åŠ è½½ã€‚' : 'DeepSeek API Key: æœªè®¾ç½®ã€‚';
                    deepseekApiKeyMessage.className = 'text-xs text-gray-500 mt-1'; // Reset class
                }, 3000);
            });

            if(clearDeepseekApiKeyButton) clearDeepseekApiKeyButton.addEventListener('click', () => {
                localStorage.removeItem('deepseekApiKey');
                deepseekApiKey = null;
                deepseekApiKeyInput.value = '';
                deepseekApiKeyMessage.textContent = 'DeepSeek API Key: æœªè®¾ç½®ã€‚';
                deepseekApiKeyMessage.className = 'text-xs text-orange-600 mt-1';
            });
            
            loadApiKeysAndModelSelection(); // Initial load

            const mindmapData = { /* ... Mindmap data remains the same as previous version ... */ 
                text: "åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ (HJ 915-2017)",
                isRoot: true,
                children: [
                    { text: "ä¸€ã€ å¼•è¨€ä¸èŒƒå›´", children: [{ text: "ç›®çš„" }, { text: "æ³•å¾‹ä¾æ®" }, { text: "é€‚ç”¨èŒƒå›´" }, { text: "è§„èŒƒæ€§å¼•ç”¨" }] },
                    { 
                        text: "äºŒã€ æ ¸å¿ƒæœ¯è¯­å®šä¹‰", 
                        children: [
                            { text: "åœ°è¡¨æ°´æ°´è´¨è‡ªåŠ¨ç›‘æµ‹" }, 
                            { text: "æ°´ç«™" }, 
                            { text: "æ•°æ®å¹³å°" }, 
                            { text: "è‡ªåŠ¨ç›‘æµ‹ç³»ç»Ÿ" }, 
                            { 
                                text: "å¸¸è§„äº”å‚æ•°",
                                quiz: [
                                    { question: "åœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹ä¸­çš„â€œå¸¸è§„äº”å‚æ•°â€é€šå¸¸ä¸åŒ…æ‹¬ä»¥ä¸‹å“ªä¸€é¡¹ï¼Ÿ", choices: ["æ°´æ¸©", "pHå€¼", "æº¶è§£æ°§", "æ€»æ°®"], correctAnswer: "æ€»æ°®" },
                                    { question: "æµ‹é‡pHå€¼çš„æ„ä¹‰åœ¨äºåæ˜ æ°´ä½“çš„ä»€ä¹ˆç‰¹æ€§ï¼Ÿ", choices: ["æ··æµŠç¨‹åº¦", "é…¸ç¢±åº¦", "å«æ°§é‡", "å¯¼ç”µèƒ½åŠ›"], correctAnswer: "é…¸ç¢±åº¦" }
                                ]
                            }
                        ] 
                    },
                    { 
                        text: "ä¸‰ã€ ç³»ç»Ÿå»ºè®¾", 
                        children: [
                            { text: "æ€»ä½“è¦æ±‚" },
                            { text: "ç«™å€é€‰æ‹©", children: [{ text: "åŸåˆ™ï¼šå¯è¡Œæ€§ã€ä»£è¡¨æ€§ã€é•¿æœŸæ€§ã€å®‰å…¨æ€§ã€ç»æµæ€§" }, { text: "åŸºç¡€æ¡ä»¶ï¼šäº¤é€šã€ç”µåŠ›(â‰¥15kW)ã€æ°´æºã€é€šè®¯ç­‰" }, { text: "ä»£è¡¨æ€§ï¼šè¿œç¦»æ±¡æŸ“æº, é¿å…å›æ°´åŒº" }] },
                            { 
                                text: "ç«™æˆ¿å»ºè®¾", 
                                children: [
                                    { text: "å½¢å¼ï¼šå›ºå®šå¼ã€ç®€æ˜“å¼ã€æµ®æ ‡ç«™ç­‰" }, 
                                    { text: "å®‰å…¨è¦æ±‚ï¼šé˜²é›·ã€æŠ—éœ‡ã€é˜²æ´ªã€é˜²ç›—ç­‰" }, 
                                    { text: "å›ºå®šç«™æˆ¿é…ç½®ï¼šä»ªå™¨é—´(â‰¥60mÂ²)ã€è´¨æ§é—´(â‰¥30mÂ²)" }, 
                                    { 
                                        text: "ç¯å¢ƒæ§åˆ¶", 
                                        quiz: [
                                            { question: "æ°´ç«™ç«™æˆ¿ç¯å¢ƒæ§åˆ¶ä¸­ï¼Œå¯¹æ¸©åº¦çš„ä¸€èˆ¬è¦æ±‚æ˜¯å¤šå°‘æ‘„æ°åº¦ï¼Ÿ", choices: ["0~10â„ƒ", "10~18â„ƒ", "18~28â„ƒ", "28~35â„ƒ"], correctAnswer: "18~28â„ƒ" },
                                            { question: "æ°´ç«™ç«™æˆ¿ç¯å¢ƒæ§åˆ¶ä¸­ï¼Œå¯¹æ¹¿åº¦çš„ä¸€èˆ¬è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ", choices: ["<40%", "<60%", ">60%", ">80%"], correctAnswer: "<60%" }
                                        ]
                                    }
                                ]
                            },
                            { text: "æ°´ç«™å„å•å…ƒå»ºè®¾", children: [{ text: "é‡‡é…æ°´å•å…ƒ (é‡‡æ°´ã€é¢„å¤„ç†ã€é…æ°´)" }, { text: "æ§åˆ¶å•å…ƒ (PLC, MTBFâ‰¥10000h)" }, { text: "æ£€æµ‹å•å…ƒ (ä»ªå™¨æ€§èƒ½éœ€ç¬¦åˆé™„å½•A.2)" }, { text: "æ•°æ®é‡‡é›†ä¸ä¼ è¾“å•å…ƒ (æœ¬åœ°å‚¨å­˜â‰¥1å¹´æ•°æ®)" }] },
                            { text: "æ•°æ®å¹³å°å»ºè®¾", children: [{ text: "æ ¸å¿ƒåŠŸèƒ½ï¼šæ•°æ®é‡‡é›†ã€è¿œç¨‹åæ§ã€åˆ†æç®¡ç†ã€æŠ¥è­¦" }, { text: "æŠ€æœ¯è¦æ±‚ï¼šå®‰å…¨ä¼ è¾“ã€å¯æ‰©å±•ã€è‡ªåŠ¨è¯†åˆ«æ— æ•ˆæ•°æ®" }] },
                        ]
                    },
                    { text: "å››ã€ ç³»ç»ŸéªŒæ”¶", special: true, children: [{ text: "æ€»ä½“è¦æ±‚" }, { text: "éªŒæ”¶ç¨‹åº" }, { text: "åŸºæœ¬æ¡ä»¶ (è‡³å°‘è¿ç»­ç¨³å®šè¿è¡Œ30å¤©)" }, { text: "è¯¦ç»†å†…å®¹ (ç«™æˆ¿ã€ä»ªå™¨ã€æ•°æ®å¹³å°)" }] },
                    { text: "äº”ã€ è¿è¡Œç»´æŠ¤ (O&M)", special: true, children: [{ text: "æ€»ä½“è¦æ±‚" }, { text: "ä¾‹è¡Œç»´æŠ¤ (å·¡æ£€é¢‘æ¬¡ â‰¥ æ¯å‘¨ä¸€æ¬¡)" }, { text: "ä¿å…»æ£€ä¿® (æ¯å¹´è‡³å°‘1æ¬¡)" }, { text: "æ•…éšœæ£€ä¿®", simulatable: true }, { text: "æ•°æ®å¹³å°ç®¡ç†" }, { text: "è®°å½•è¦æ±‚" }] },
                    { text: "å…­ã€ è´¨é‡ä¿è¯ä¸è´¨é‡æ§åˆ¶ (QA/QC)", children: [ { text: "é‡å€¼ä¼ é€’è¦æ±‚ (ä½¿ç”¨æœ‰è¯æ ‡å‡†æ ·å“)" }, { text: "ä»ªå™¨æ€§èƒ½æ ¸æŸ¥", children: [{ text: "å†…å®¹ï¼šå‡†ç¡®åº¦ã€ç²¾å¯†åº¦ã€æ£€å‡ºé™ç­‰" }, { text: "é¢‘ç‡ï¼šå¤§éƒ¨åˆ†æŒ‡æ ‡â‰¥æ¯åŠå¹´ä¸€æ¬¡ï¼Œæ ¡å‡†â‰¥æ¯æœˆä¸€æ¬¡" }, { text: "æ–¹æ³•ä¸å…¬å¼" }, { text: "å®é™…æ°´æ ·æ¯”å¯¹" }] } ] },
                    { text: "ä¸ƒã€ æ•°æ®é‡‡é›†ä¸æœ‰æ•ˆæ€§", simulatable: true, children: [ { text: "é‡‡é›†é¢‘ç‡", quiz: [ { question: "ã€ŠHJ 915-2017ã€‹è§„èŒƒä¸­ï¼Œåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹ç³»ç»Ÿä¸€èˆ¬çš„æ•°æ®é‡‡é›†é¢‘ç‡æ˜¯å¤šå°‘ï¼Ÿ", choices: ["æ¯15åˆ†é’Ÿä¸€æ¬¡", "æ¯å°æ—¶ä¸€æ¬¡", "æ¯2å°æ—¶ä¸€æ¬¡", "æ¯4å°æ—¶ä¸€æ¬¡"], correctAnswer: "æ¯4å°æ—¶ä¸€æ¬¡" } ] }, { text: "æ•°æ®æœ‰æ•ˆæ€§ (å­˜ç–‘æ•°æ®24hå†…ç”„åˆ«)" }, { text: "æ•°æ®æœ‰æ•ˆç‡ (>90%)" } ] },
                    { text: "å…«ã€ ä¿éšœåˆ¶åº¦", children: [{ text: "è¿è¡Œç®¡ç†åŠæ³•" }, { text: "å²—ä½èŒè´£" }, { text: "è´¨é‡ç®¡ç†ä¿éšœåˆ¶åº¦" }, { text: "ä»ªå™¨æ“ä½œè§„ç¨‹ (SOPs)" }, { text: "åŸ¹è®­åŠè€ƒæ ¸åˆ¶åº¦" }, { text: "æ¡£æ¡ˆç®¡ç†åˆ¶åº¦" }] },
                    { text: "ä¹ã€ ç›‘æµ‹é¡¹ç›®ä¸ä»ªå™¨æ€§èƒ½", children: [ { text: "ç›‘æµ‹é¡¹ç›®", children: [{ text: "æ²³æµå¿…æµ‹ï¼šå¸¸è§„äº”å‚æ•°ã€é«˜é”°é…¸ç›æŒ‡æ•°ã€æ°¨æ°®ã€æ€»ç£·ã€æ€»æ°®" }, { text: "æ¹–åº“å¿…æµ‹ï¼šå¢åŠ å¶ç»¿ç´ a" }, { text: "é€‰æµ‹é¡¹ç›®" }] }, { text: "ä»ªå™¨æ€§èƒ½è¦æ±‚ (é™„å½•A.2)", children: [{ text: "è§„èŒƒæ€§é™„å½•ï¼Œå…·å¼ºåˆ¶æ€§" }, { text: "è§„å®šå…·ä½“æŠ€æœ¯æŒ‡æ ‡ (æ£€å‡ºé™ã€ç²¾å¯†åº¦ç­‰)" }, { text: "æä¾›é‡åŒ–åŸºå‡†" }] } ] }
                ]
            };

            const treeContainer = document.querySelector('.tree');
            treeContainer.innerHTML = ''; 
            treeContainer.appendChild(createTree(mindmapData));

            function createTree(nodeData) {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.className = 'node';
                span.textContent = nodeData.text;
                if (nodeData.isRoot) li.classList.add('root');
                if (nodeData.children && nodeData.children.length > 0) {
                    li.classList.add('has-children');
                    const toggleIcon = document.createElement('span');
                    toggleIcon.className = 'toggle-icon';
                    toggleIcon.textContent = 'âˆ’';
                    span.prepend(toggleIcon);
                    const ul = document.createElement('ul');
                    nodeData.children.forEach(child => ul.appendChild(createTree(child)));
                    li.appendChild(span);
                    li.appendChild(ul);
                } else {
                    li.appendChild(span);
                }
                if (!nodeData.isRoot) {
                    const aiTrigger = document.createElement('span');
                    aiTrigger.className = 'ai-trigger';
                    aiTrigger.title = 'âœ¨ æ™ºèƒ½è§£è¯»';
                    aiTrigger.innerHTML = 'âœ¨';
                    span.appendChild(aiTrigger);
                    aiTrigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openAIModalForNode(nodeData, nodeData.text, nodeData.special);
                    });
                    if (nodeData.simulatable) {
                        const simTrigger = document.createElement('span');
                        simTrigger.className = 'simulation-trigger';
                        simTrigger.title = 'ğŸ§  AIåœºæ™¯æ¨¡æ‹Ÿ';
                        simTrigger.innerHTML = 'ğŸ§ ';
                        span.appendChild(simTrigger);
                        simTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openSimulationModal(nodeData.text);
                        });
                    }
                }
                return li;
            }

            const tree = document.querySelector('.tree');
            if(tree) tree.addEventListener('click', function (event) { /* ... tree click logic ... */ 
                const target = event.target;
                if (target.matches('.node, .toggle-icon')) {
                    const parentLi = target.closest('li.has-children');
                    if (parentLi) {
                        parentLi.classList.toggle('collapsed');
                        const toggleIcon = parentLi.querySelector('.toggle-icon');
                        if(toggleIcon) toggleIcon.textContent = parentLi.classList.contains('collapsed') ? '+' : 'âˆ’';
                    }
                }
            });
            
            const expandAllBtn = document.getElementById('expandAll');
            if(expandAllBtn) expandAllBtn.addEventListener('click', function() { /* ... expand all logic ... */ 
                 tree.querySelectorAll('li.has-children').forEach(node => {
                    node.classList.remove('collapsed');
                    if(node.querySelector('.toggle-icon')) node.querySelector('.toggle-icon').textContent = 'âˆ’';
                });
            });

            const collapseAllBtn = document.getElementById('collapseAll');
            if(collapseAllBtn) collapseAllBtn.addEventListener('click', function() { /* ... collapse all logic ... */ 
                tree.querySelectorAll('li.has-children').forEach(node => {
                    if (!node.classList.contains('root')) {
                        node.classList.add('collapsed');
                         if(node.querySelector('.toggle-icon')) node.querySelector('.toggle-icon').textContent = '+';
                    }
                });
            });
            
            if(collapseAllBtn) collapseAllBtn.click();
            const rootNode = document.querySelector('.tree > li.root');
            if(rootNode) rootNode.classList.remove('collapsed');


            const modal = document.getElementById('aiModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalActions = document.getElementById('modalActions');
            const closeModalBtn = document.getElementById('closeModal');

            if(closeModalBtn) closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            if(modal) modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            async function callAIModel(prompt) {
                const modelToUse = selectedAiModel;
                let apiKeyToUse = null;
                let apiUrl = '';
                let payload = {};
                let headers = {};
                let modelNameForError = '';

                if (modelToUse === 'gemini') {
                    apiKeyToUse = geminiApiKey;
                    modelNameForError = 'Gemini';
                    if (!apiKeyToUse) {
                        modalTitle.textContent = "Gemini API Key æœªè®¾ç½®";
                        modalContent.innerHTML = '<p class="text-red-500 font-semibold">é”™è¯¯ï¼šGemini API Key æœªè®¾ç½®ã€‚</p><p>è¯·åœ¨é¡µé¢é¡¶éƒ¨çš„Gemini API Keyè¾“å…¥æ¡†ä¸­è®¾ç½®æ‚¨çš„å¯†é’¥ï¼Œç„¶åé‡è¯•ã€‚</p>';
                        if (modalActions) modalActions.innerHTML = '';
                        if (modal && modal.classList.contains('hidden')) modal.classList.remove('hidden');
                        return Promise.reject("Gemini API Keyæœªè®¾ç½®");
                    }
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKeyToUse}`;
                    payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    headers = { 'Content-Type': 'application/json' };
                } else if (modelToUse === 'deepseek') {
                    apiKeyToUse = deepseekApiKey;
                    modelNameForError = 'DeepSeek';
                    if (!apiKeyToUse) {
                        modalTitle.textContent = "DeepSeek API Key æœªè®¾ç½®";
                        modalContent.innerHTML = '<p class="text-red-500 font-semibold">é”™è¯¯ï¼šDeepSeek API Key æœªè®¾ç½®ã€‚</p><p>è¯·åœ¨é¡µé¢é¡¶éƒ¨çš„DeepSeek API Keyè¾“å…¥æ¡†ä¸­è®¾ç½®æ‚¨çš„å¯†é’¥ï¼Œç„¶åé‡è¯•ã€‚</p>';
                        if (modalActions) modalActions.innerHTML = '';
                        if (modal && modal.classList.contains('hidden')) modal.classList.remove('hidden');
                        return Promise.reject("DeepSeek API Keyæœªè®¾ç½®");
                    }
                    apiUrl = "https://api.deepseek.com/v1/chat/completions";
                    payload = { model: "deepseek-chat", messages: [{ role: "user", content: prompt }] };
                    headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKeyToUse}` };
                } else {
                    modalTitle.textContent = "æœªé€‰æ‹©AIæ¨¡å‹";
                    modalContent.innerHTML = '<p class="text-red-500 font-semibold">é”™è¯¯ï¼šæœªé€‰æ‹©AIæ¨¡å‹ã€‚</p><p>è¯·åœ¨é¡µé¢é¡¶éƒ¨é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹ï¼Œç„¶åé‡è¯•ã€‚</p>';
                    if (modalActions) modalActions.innerHTML = '';
                    if (modal && modal.classList.contains('hidden')) modal.classList.remove('hidden');
                    return Promise.reject("æœªé€‰æ‹©AIæ¨¡å‹");
                }

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} ${await response.text()}`);
                    const result = await response.json();

                    if (modelToUse === 'gemini') {
                        if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else { throw new Error(`${modelNameForError} APIå“åº”æ ¼å¼ä¸æ­£ç¡®ã€‚`); }
                    } else if (modelToUse === 'deepseek') {
                         if (result.choices && result.choices[0] && result.choices[0].message && result.choices[0].message.content) {
                            return result.choices[0].message.content;
                        } else { throw new Error(`${modelNameForError} APIå“åº”æ ¼å¼ä¸æ­£ç¡®ã€‚`); }
                    }
                } catch (error) {
                    console.error(`${modelNameForError} API call failed:`, error);
                    modalTitle.textContent = `${modelNameForError} AI è°ƒç”¨å¤±è´¥`;
                    modalContent.innerHTML = `<p class="text-red-500">è°ƒç”¨${modelNameForError} AIæœåŠ¡å¤±è´¥ã€‚</p><p class="text-sm mt-2">é”™è¯¯è¯¦æƒ…: ${error.message}</p><p class="text-sm mt-2">è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€APIå¯†é’¥æ˜¯å¦æ­£ç¡®ä¸”æœ‰æƒè®¿é—®${modelNameForError} APIï¼Œæˆ–ç¨åå†è¯•ã€‚</p>`;
                    return Promise.reject(error.message);
                }
            }

            async function openModalWithContent(title, contentPromise) {
                modal.classList.remove('hidden');
                modalTitle.textContent = title;
                modalContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>';
                modalActions.innerHTML = '';
                try {
                    const result = await contentPromise;
                    modalContent.textContent = result; 
                } catch (error) {
                    // Error display is now primarily handled within callAIModel
                    // This catch is a fallback or for non-API related promise rejections
                    if (!modalContent.textContent.includes("é”™è¯¯ï¼š") && !modalContent.textContent.includes("è°ƒç”¨å¤±è´¥")) {
                         modalContent.textContent = "åŠ è½½å†…å®¹æ—¶å‘ç”Ÿé”™è¯¯ã€‚";
                    }
                     console.log("Error in openModalWithContent:", error); // Log for debugging
                }
            }
            
            let currentQuizDataSession = null; 
            let currentQuestionIndexSession = 0; 
            let scoreSession = 0; 

            function displayQuiz(quizData) { /* ... displayQuiz and related functions remain the same ... */ 
                currentQuizDataSession = quizData;
                currentQuestionIndexSession = 0;
                scoreSession = 0;
                modalTitle.textContent = "ç« èŠ‚å°æµ‹éªŒ"; 
                renderCurrentQuestion();
            }

            function renderCurrentQuestion() { /* ... same ... */ 
                const modalContentDiv = document.getElementById('modalContent');
                const modalActionsDiv = document.getElementById('modalActions');
                modalContentDiv.innerHTML = '';
                modalActionsDiv.innerHTML = '';
                if (!currentQuizDataSession || currentQuestionIndexSession >= currentQuizDataSession.length) {
                    showQuizSummary(); return;
                }
                const questionData = currentQuizDataSession[currentQuestionIndexSession];
                const questionElement = document.createElement('h4');
                questionElement.className = 'text-lg font-semibold mb-3';
                questionElement.textContent = `é—®é¢˜ ${currentQuestionIndexSession + 1}/${currentQuizDataSession.length}: ${questionData.question}`;
                modalContentDiv.appendChild(questionElement);
                const choicesContainer = document.createElement('div');
                questionData.choices.forEach(choiceText => {
                    const choiceButton = document.createElement('button');
                    choiceButton.textContent = choiceText;
                    choiceButton.className = 'choice-button';
                    choiceButton.addEventListener('click', () => handleAnswer(choiceButton, choiceText, questionData));
                    choicesContainer.appendChild(choiceButton);
                });
                modalContentDiv.appendChild(choicesContainer);
            }

            function handleAnswer(clickedButton, selectedChoice, questionData) { /* ... same ... */
                const allChoiceButtons = clickedButton.parentElement.querySelectorAll('.choice-button');
                allChoiceButtons.forEach(btn => btn.disabled = true);
                if (selectedChoice === questionData.correctAnswer) {
                    scoreSession++; clickedButton.classList.add('correct');
                } else {
                    clickedButton.classList.add('incorrect');
                    allChoiceButtons.forEach(btn => { if (btn.textContent === questionData.correctAnswer) btn.classList.add('correct'); });
                }
                showNavigationButtons();
            }

            function showNavigationButtons() { /* ... same ... */
                const modalActionsDiv = document.getElementById('modalActions');
                modalActionsDiv.innerHTML = ''; 
                if (currentQuestionIndexSession < currentQuizDataSession.length - 1) {
                    const nextButton = document.createElement('button');
                    nextButton.textContent = 'ä¸‹ä¸€é¢˜';
                    nextButton.className = 'control-btn bg-indigo-500 text-white hover:bg-indigo-600';
                    nextButton.addEventListener('click', () => { currentQuestionIndexSession++; renderCurrentQuestion(); });
                    modalActionsDiv.appendChild(nextButton);
                } else {
                    const finishButton = document.createElement('button');
                    finishButton.textContent = 'å®Œæˆæµ‹éªŒ';
                    finishButton.className = 'control-btn bg-green-500 text-white hover:bg-green-600';
                    finishButton.addEventListener('click', showQuizSummary);
                    modalActionsDiv.appendChild(finishButton);
                }
            }
            function showQuizSummary() { /* ... same ... */
                const modalContentDiv = document.getElementById('modalContent');
                const modalActionsDiv = document.getElementById('modalActions');
                modalContentDiv.innerHTML = `<h3 class="text-xl font-bold text-center mb-4">æµ‹éªŒå®Œæˆ!</h3><p class="text-center text-lg">ä½ ç­”å¯¹äº† ${scoreSession} / ${currentQuizDataSession.length} é¢˜ã€‚</p>`;
                modalActionsDiv.innerHTML = '';
                const closeButton = document.createElement('button');
                closeButton.textContent = 'å…³é—­';
                closeButton.className = 'control-btn';
                closeButton.onclick = () => { modal.classList.add('hidden'); };
                modalActionsDiv.appendChild(closeButton);
            }

            async function openAIModalForNode(nodeData, nodeText, isSpecial) { /* ... uses callAIModel ... */ 
                const prompt = `è¯·æ ¹æ®ã€Šåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ HJ 915-2017ã€‹çš„å†…å®¹ï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è¯¦ç»†è§£é‡Š'${nodeText}'è¿™ä¸€èŠ‚çš„æ ¸å¿ƒå†…å®¹å’Œé‡è¦æ€§ã€‚`;
                try {
                    await openModalWithContent(`å…³äºâ€œ${nodeText}â€çš„æ™ºèƒ½è§£è¯»`, callAIModel(prompt));
                    const modalActionsDiv = document.getElementById('modalActions'); // Ensure it's freshly obtained
                    // modalActionsDiv.innerHTML = ''; // openModalWithContent clears it.

                    if (isSpecial) {
                        const checklistBtn = document.createElement('button');
                        checklistBtn.className = 'control-btn bg-blue-500 text-white hover:bg-blue-600';
                        checklistBtn.innerHTML = 'âœ¨ ç”Ÿæˆæ£€æŸ¥æ¸…å•';
                        checklistBtn.onclick = async () => {
                             const checklistPromptBtn = `æ ¹æ®ã€Šåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ HJ 915-2017ã€‹ä¸­å…³äº'${nodeText}'çš„å…¨éƒ¨è¦æ±‚ï¼Œç”Ÿæˆä¸€ä»½è¯¦ç»†ã€å¯æ“ä½œçš„ç°åœºæ£€æŸ¥æ¸…å•ï¼Œè¯·ä½¿ç”¨Markdownæ ¼å¼ã€‚`;
                             openModalWithContent(`â€œ${nodeText}â€æ£€æŸ¥æ¸…å•`, callAIModel(checklistPromptBtn));
                        };
                        modalActionsDiv.appendChild(checklistBtn);
                    }
                    if (nodeData.quiz && nodeData.quiz.length > 0) {
                        const quizButton = document.createElement('button');
                        quizButton.innerHTML = 'ğŸ“ å¼€å§‹æµ‹éªŒ';
                        quizButton.className = 'control-btn bg-purple-500 text-white hover:bg-purple-600';
                        quizButton.addEventListener('click', () => displayQuiz(nodeData.quiz));
                        modalActionsDiv.appendChild(quizButton);
                    }
                } catch (error) { console.log("Error handled by callAIModel/openModalWithContent in openAIModalForNode:", error); }
            }
            
            async function openSimulationModal(nodeText) { /* ... uses callAIModel ... */ 
                const scenarioPrompt = `æ‚¨æ˜¯ä¸€ååœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹ç«™çš„è¿ç»´åŸ¹è®­ä¸“å®¶ã€‚è¯·æ ¹æ®ã€Šåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ HJ 915-2017ã€‹å…³äº'${nodeText}'çš„è¦æ±‚ï¼Œè®¾è®¡ä¸€ä¸ªå¸¸è§çš„ã€å…·ä½“çš„å®è·µåœºæ™¯é—®é¢˜æ¥æŒ‘æˆ˜ç”¨æˆ·ã€‚è¯·ä»¥åœºæ™¯æè¿°å’Œæé—®çš„æ–¹å¼å‘ˆç°ï¼Œå¼•å¯¼ç”¨æˆ·æ€è€ƒå¦‚ä½•åº”å¯¹ã€‚`;
                try {
                    await openModalWithContent(`å…³äºâ€œ${nodeText}â€çš„åœºæ™¯æ¨¡æ‹Ÿ`, callAIModel(scenarioPrompt).then(scenario => {
                        if (scenario && !scenario.startsWith("è°ƒç”¨") && !scenario.startsWith("é”™è¯¯ï¼š")) { // Check if scenario fetch was successful
                            const modalActionsDiv = document.getElementById('modalActions');
                            const solutionBtn = document.createElement('button');
                            solutionBtn.className = 'control-btn bg-green-500 text-white hover:bg-green-600';
                            solutionBtn.innerHTML = 'æŸ¥çœ‹è§£å†³æ–¹æ¡ˆ';
                            solutionBtn.onclick = async () => {
                                const solutionPrompt = `é’ˆå¯¹ä»¥ä¸‹åœºæ™¯é—®é¢˜ï¼šâ€œ${modalContent.textContent}â€ã€‚è¯·æ ¹æ®ã€Šåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ HJ 915-2017ã€‹çš„è¦æ±‚ï¼Œæä¾›ä¸€ä»½æ ‡å‡†ã€è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆå’Œå¤„ç†æµç¨‹ã€‚`;
                                openModalWithContent(`â€œ${nodeText}â€åœºæ™¯è§£å†³æ–¹æ¡ˆ`, callAIModel(solutionPrompt));
                            };
                            modalActionsDiv.appendChild(solutionBtn);
                        } // else: error already displayed by callAIModel
                        return scenario; 
                    }));
                } catch (error) { console.log("Error handled by callAIModel/openModalWithContent in openSimulationModal:", error); }
            }

            const searchForm = document.getElementById('aiSearchForm'); 
            const searchInput = document.getElementById('aiSearchInput'); 
            if(searchForm) searchForm.addEventListener('submit', async (e) => { /* ... uses callAIModel ... */ 
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) return;
                const prompt = `æ‚¨æ˜¯ä¸€ä½ç†Ÿæ‚‰ã€Šåœ°è¡¨æ°´è‡ªåŠ¨ç›‘æµ‹æŠ€æœ¯è§„èŒƒ HJ 915-2017ã€‹çš„ä¸“å®¶ã€‚è¯·æ ¹æ®è¯¥è§„èŒƒçš„è¯¦ç»†å†…å®¹ï¼Œå›ç­”ä»¥ä¸‹é—®é¢˜ï¼šâ€œ${query}â€ã€‚è¯·ç¡®ä¿æ‚¨çš„å›ç­”å‡†ç¡®ã€è¯¦ç»†ï¼Œå¹¶å°½å¯èƒ½å¼•ç”¨è§„èŒƒä¸­çš„å…³é”®ç‚¹ã€‚`;
                openModalWithContent(`å…³äºâ€œ${query}â€çš„è§£ç­”`, callAIModel(prompt));
                searchInput.value = '';
            });
        });
    </script>
</body>
</html>