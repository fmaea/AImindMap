<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地表水自动监测技术规范 (HJ 915-2017) 交互式思维导图 (Gemini版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f9fafb;
        }

        .tree-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 2rem auto;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .tree ul {
            position: relative;
            padding-left: 30px;
            list-style: none;
        }

        .tree li {
            position: relative;
            padding: 4px 0 4px 25px;
        }

        .tree ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background-color: #d1d5db;
        }
        
        .tree li::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            width: 25px;
            height: 1px;
            background-color: #d1d5db;
        }
        
        .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background-color: #d1d5db;
        }

        .tree li:last-child::after {
            height: 15px;
        }
        
        .tree .node {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 8px;
            background-color: #f3f4f6;
            color: #374151;
            transition: all 0.2s ease;
            min-width: 100px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }
        
        .tree .gemini-trigger, .tree .simulation-trigger {
            margin-left: 8px;
            font-size: 1.1rem;
            opacity: 0.6;
            transition: all 0.2s ease;
        }
        .tree .node:hover .gemini-trigger, .tree .node:hover .simulation-trigger {
            opacity: 1;
            transform: scale(1.2);
        }

        .tree li.has-children > .node {
            cursor: pointer;
            font-weight: 500;
            background-color: #e0e7ff;
            color: #3730a3;
        }
        
        .tree li.has-children > .node:hover {
             background-color: #c7d2fe;
             transform: translateY(-2px);
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .tree li.root > .node {
            background-color: #312e81;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .tree li.collapsed > ul {
            display: none;
        }

        .tree li.has-children > .node > .toggle-icon {
            content: '−';
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }

        .tree li.has-children.collapsed > .node > .toggle-icon {
            content: '+';
        }
        
        .controls {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .control-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .control-btn:hover {
            background-color: #f3f4f6;
        }
        
        /* Modal Styles */
        .modal-content {
            white-space: pre-wrap;
            line-height: 1.7;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="tree-container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">地表水自动监测技术规范</h1>
        <p class="text-lg text-center text-gray-500 mb-8">(HJ 915-2017) 交互式思维导图 - Gemini 增强版</p>
        
        <!-- Gemini Search Bar -->
        <div class="mb-8 max-w-2xl mx-auto">
            <form id="geminiSearchForm" class="flex items-center gap-2 p-2 border-2 border-indigo-200 rounded-full shadow-lg focus-within:border-indigo-500 transition-all">
                <input type="search" id="geminiSearchInput" placeholder="✨ 就规范内容提问，让Gemini为您解答..." class="w-full px-4 py-2 text-gray-700 bg-transparent focus:outline-none">
                <button type="submit" class="bg-indigo-600 text-white rounded-full p-2.5 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </button>
            </form>
        </div>

        <div class="controls space-x-4">
            <button id="expandAll" class="control-btn">全部展开</button>
            <button id="collapseAll" class="control-btn">全部折叠</button>
        </div>

        <ul class="tree">
            <!-- Mindmap structure will be generated by JS -->
        </ul>
    </div>

    <!-- Gemini Modal -->
    <div id="geminiModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-2xl bg-white">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <div id="modalContent" class="modal-content text-gray-700 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Gemini response will be injected here -->
            </div>
            <div id="modalActions" class="mt-4 text-right">
                 <!-- Action buttons will be injected here -->
            </div>
            <button id="closeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            const mindmapData = {
                text: "地表水自动监测技术规范 (HJ 915-2017)",
                isRoot: true,
                children: [
                    { text: "一、 引言与范围", children: [{ text: "目的" }, { text: "法律依据" }, { text: "适用范围" }, { text: "规范性引用" }] },
                    { text: "二、 核心术语定义", children: [{ text: "地表水水质自动监测" }, { text: "水站" }, { text: "数据平台" }, { text: "自动监测系统" }, { text: "常规五参数" }] },
                    { text: "三、 系统建设", children: [
                        { text: "总体要求" },
                        { text: "站址选择", children: [{ text: "原则：可行性、代表性、长期性、安全性、经济性" }, { text: "基础条件：交通、电力(≥15kW)、水源、通讯等" }, { text: "代表性：远离污染源, 避免回水区" }] },
                        { text: "站房建设", children: [{ text: "形式：固定式、简易式、浮标站等" }, { text: "安全要求：防雷、抗震、防洪、防盗等" }, { text: "固定站房配置：仪器间(≥60m²)、质控间(≥30m²)" }, { text: "环境控制：温度18~28℃，湿度<60%" }]},
                        { text: "水站各单元建设", children: [{ text: "采配水单元 (采水、预处理、配水)" }, { text: "控制单元 (PLC, MTBF≥10000h)" }, { text: "检测单元 (仪器性能需符合附录A.2)" }, { text: "数据采集与传输单元 (本地储存≥1年数据)" }] },
                        { text: "数据平台建设", children: [{ text: "核心功能：数据采集、远程反控、分析管理、报警" }, { text: "技术要求：安全传输、可扩展、自动识别无效数据" }] },
                    ]},
                    { text: "四、 系统验收", special: true, children: [{ text: "总体要求" }, { text: "验收程序" }, { text: "基本条件 (至少连续稳定运行30天)" }, { text: "详细内容 (站房、仪器、数据平台)" }] },
                    { text: "五、 运行维护 (O&M)", special: true, children: [{ text: "总体要求" }, { text: "例行维护 (巡检频次 ≥ 每周一次)" }, { text: "保养检修 (每年至少1次)" }, { text: "故障检修", simulatable: true }, { text: "数据平台管理" }, { text: "记录要求" }] },
                    { text: "六、 质量保证与质量控制 (QA/QC)", children: [
                        { text: "量值传递要求 (使用有证标准样品)" },
                        { text: "仪器性能核查", children: [{ text: "内容：准确度、精密度、检出限等" }, { text: "频率：大部分指标≥每半年一次，校准≥每月一次" }, { text: "方法与公式" }, { text: "实际水样比对" }] },
                    ]},
                    { text: "七、 数据采集与有效性", simulatable: true, children: [{ text: "采集频率 (一般4小时/次)" }, { text: "数据有效性 (存疑数据24h内甄别)" }, { text: "数据有效率 (>90%)" }] },
                    { text: "八、 保障制度", children: [{ text: "运行管理办法" }, { text: "岗位职责" }, { text: "质量管理保障制度" }, { text: "仪器操作规程 (SOPs)" }, { text: "培训及考核制度" }, { text: "档案管理制度" }] },
                    { text: "九、 监测项目与仪器性能", children: [
                        { text: "监测项目", children: [{ text: "河流必测：常规五参数、高锰酸盐指数、氨氮、总磷、总氮" }, { text: "湖库必测：增加叶绿素a" }, { text: "选测项目" }] },
                        { text: "仪器性能要求 (附录A.2)", children: [{ text: "规范性附录，具强制性" }, { text: "规定具体技术指标 (检出限、精密度等)" }, { text: "提供量化基准" }] },
                    ]}
                ]
            };

            const treeContainer = document.querySelector('.tree');
            treeContainer.innerHTML = ''; // Clear static content
            treeContainer.appendChild(createTree(mindmapData));

            function createTree(nodeData) {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.className = 'node';
                span.textContent = nodeData.text;

                if (nodeData.isRoot) {
                    li.classList.add('root');
                }

                if (nodeData.children && nodeData.children.length > 0) {
                    li.classList.add('has-children');
                    const toggleIcon = document.createElement('span');
                    toggleIcon.className = 'toggle-icon';
                    toggleIcon.textContent = '−';
                    span.prepend(toggleIcon);

                    const ul = document.createElement('ul');
                    nodeData.children.forEach(child => ul.appendChild(createTree(child)));
                    li.appendChild(span);
                    li.appendChild(ul);
                } else {
                    li.appendChild(span);
                }
                
                if (!nodeData.isRoot) {
                    const geminiTrigger = document.createElement('span');
                    geminiTrigger.className = 'gemini-trigger';
                    geminiTrigger.title = '✨ 智能解读';
                    geminiTrigger.innerHTML = '✨';
                    span.appendChild(geminiTrigger);
                    geminiTrigger.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openGeminiModalForNode(nodeData.text, nodeData.special);
                    });
                    
                    if (nodeData.simulatable) {
                        const simTrigger = document.createElement('span');
                        simTrigger.className = 'simulation-trigger';
                        simTrigger.title = '🧠 AI场景模拟';
                        simTrigger.innerHTML = '🧠';
                        span.appendChild(simTrigger);
                        simTrigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openSimulationModal(nodeData.text);
                        });
                    }
                }
                return li;
            }

            const tree = document.querySelector('.tree');
            tree.addEventListener('click', function (event) {
                const target = event.target;
                if (target.matches('.node, .toggle-icon')) {
                    const parentLi = target.closest('li.has-children');
                    if (parentLi) {
                        parentLi.classList.toggle('collapsed');
                        const toggleIcon = parentLi.querySelector('.toggle-icon');
                        toggleIcon.textContent = parentLi.classList.contains('collapsed') ? '+' : '−';
                    }
                }
            });

            document.getElementById('expandAll').addEventListener('click', function() {
                tree.querySelectorAll('li.has-children').forEach(node => {
                    node.classList.remove('collapsed');
                    if(node.querySelector('.toggle-icon')) node.querySelector('.toggle-icon').textContent = '−';
                });
            });

            document.getElementById('collapseAll').addEventListener('click', function() {
                tree.querySelectorAll('li.has-children').forEach(node => {
                    if (!node.classList.contains('root')) {
                        node.classList.add('collapsed');
                         if(node.querySelector('.toggle-icon')) node.querySelector('.toggle-icon').textContent = '+';
                    }
                });
            });

            document.getElementById('collapseAll').click();
            document.querySelector('.tree > li.root').classList.remove('collapsed');

            const modal = document.getElementById('geminiModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const modalActions = document.getElementById('modalActions');
            const closeModalBtn = document.getElementById('closeModal');

            closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            async function callGeminiAPI(prompt) {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        return "抱歉，无法获取AI响应。请稍后再试。";
                    }
                } catch(error) {
                    console.error("Gemini API call failed:", error);
                    return "调用AI服务失败，请检查网络连接或稍后再试。";
                }
            }

            async function openModalWithContent(title, contentPromise) {
                modal.classList.remove('hidden');
                modalTitle.textContent = title;
                modalContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>';
                modalActions.innerHTML = '';
                const result = await contentPromise;
                modalContent.textContent = result;
            }

            async function openGeminiModalForNode(nodeText, isSpecial) {
                const prompt = `请根据《地表水自动监测技术规范 HJ 915-2017》的内容，用通俗易懂的语言详细解释'${nodeText}'这一节的核心内容和重要性。`;
                openModalWithContent(`关于“${nodeText}”的智能解读`, callGeminiAPI(prompt));

                if (isSpecial) {
                    const interpretationPromise = callGeminiAPI(prompt);
                    const result = await interpretationPromise;
                    modalContent.textContent = result;

                    const checklistBtn = document.createElement('button');
                    checklistBtn.className = 'control-btn bg-blue-500 text-white hover:bg-blue-600';
                    checklistBtn.innerHTML = '✨ 生成检查清单';
                    checklistBtn.onclick = async () => {
                         const checklistPrompt = `根据《地表水自动监测技术规范 HJ 915-2017》中关于'${nodeText}'的全部要求，生成一份详细、可操作的现场检查清单，请使用Markdown格式。`;
                         openModalWithContent(`“${nodeText}”检查清单`, callGeminiAPI(checklistPrompt));
                    };
                    modalActions.appendChild(checklistBtn);
                }
            }
            
            async function openSimulationModal(nodeText) {
                modal.classList.remove('hidden');
                modalTitle.textContent = `关于“${nodeText}”的场景模拟`;
                modalContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>';
                modalActions.innerHTML = '';

                const scenarioPrompt = `您是一名地表水自动监测站的运维培训专家。请根据《地表水自动监测技术规范 HJ 915-2017》关于'${nodeText}'的要求，设计一个常见的、具体的实践场景问题来挑战用户。请以场景描述和提问的方式呈现，引导用户思考如何应对。`;
                const scenario = await callGeminiAPI(scenarioPrompt);
                modalContent.textContent = scenario;
                
                const solutionBtn = document.createElement('button');
                solutionBtn.className = 'control-btn bg-green-500 text-white hover:bg-green-600';
                solutionBtn.innerHTML = '查看解决方案';
                solutionBtn.onclick = async () => {
                    modalContent.innerHTML = '<div class="flex justify-center items-center h-48"><div class="spinner"></div></div>';
                    const solutionPrompt = `针对以下场景问题：“${scenario}”。请根据《地表水自动监测技术规范 HJ 915-2017》的要求，提供一份标准、详细的解决方案和处理流程。`;
                    const solution = await callGeminiAPI(solutionPrompt);
                    modalContent.textContent = solution;
                    modalActions.innerHTML = ''; // Hide button after showing solution
                };
                modalActions.appendChild(solutionBtn);
            }

            const searchForm = document.getElementById('geminiSearchForm');
            const searchInput = document.getElementById('geminiSearchInput');
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (!query) return;
                const prompt = `您是一位熟悉《地表水自动监测技术规范 HJ 915-2017》的专家。请根据该规范的详细内容，回答以下问题：“${query}”。请确保您的回答准确、详细，并尽可能引用规范中的关键点。`;
                openModalWithContent(`关于“${query}”的解答`, callGeminiAPI(prompt));
                searchInput.value = '';
            });
        });
    </script>
</body>
</html>
